<!DOCTYPE html>
<html class="full-height" lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    
    <title>Single Cell Explorer</title>    
    {% include  "common/libx1.html"  %}
  </head>

  <style type="text/css">
   
    html, body{
        min-height: 100% !important;
        height: 100%;
        min-width:860px;
    }
    
    .node{

      cursor: pointer;



    }

    .scattertooltip {  
      position: absolute;     
      
      opacity: 0.9;
      padding: 2px;       
      font: 12px sans-serif;    
      background: lightsteelblue;
      background-opacity:0.7; 
      border: 0px;
      border-radius: 8px;     
      pointer-events: none;
      display: none;    
         
  }

 

    .node_draw_path {
            fill: none;
            stroke-width: 1px;
            stroke: #278BC5;
    }
     

    .node_done_path {
            fill: none;
            stroke-width: 1px;
            stroke: #278BC5;
    }






  </style>

  <body>
    <nav class="navbar navbar-light bg-light static-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Single Cell Explorer</a>
        <!--a class="nav-link" href="/" style='color:#0d47a1;'>Index</a>
        <a class="btn btn-primary" href="#">Sign In</a-->
        
      </div>
    </nav>


    
    <div style="height: 13px;"></div>
    <div class="container-fluid" style="height: calc(100% - 87px);">
      <div class='row h-100' style="min-height: 340px;">

        <div style='width: 67%;' >
            <div class='col-12 h-100'>
              <div class='card h-100' id='mainpanel'>
                   
                  

              </div>
            </div>

        </div>

        <div style='width: 33%;'>
            <div class='h-100' style="margin-right: 8px;">
              <div class='h-100' id='infopanel'  style="overflow-y: auto;">
                  

              </div>
            </div>

        </div>
      </div>


    </div>




    <div id='loadingcanvas' style="position: fixed;width: 100%;height: 100%;left:0;top:0;background :rgba(192, 192, 192, .6);z-index:9999999;display: none;" >
        <div class="h-100" style="display: flex;justify-content: center;align-items: center;vertical-align: middle;">
            <div class="loader">
                  <div class="dot dot1"><i></i></div>
                  <div class="dot dot2"><i></i></div>
                  <div class="dot dot3"><i></i></div>
                  <div class="dot dot4"><i></i></div>
                  <div class="dot dot5"><i></i></div>
                  <div class="dot dot6"><i></i></div>
                  <div class="dot dot7"><i></i></div>
                  <div class="dot dot8"><i></i></div>
                  <div class="dot dot9"><i></i></div>
            </div>
        </div>



    </div>


     
      <div id="dragablediv" class='shadow mb-5 bg-white rounded' style="width: 600px;position: absolute;top: 100px;right: 30px;display: none;">
        <div class='card'>
          <div name="dragabledivheader" class="card-header" style='cursor:move;'>
              <span name='dragablepaneltitle' style='color:steelblue;font-weight: bold;font-size: 20px;'></span>

              <button type="button" class="close" name='closedragablepanel'>
                <span>&times;</span>
              </button>

          </div>

          <div class="card-body">
            
              

          </div>
          

        </div>
      </div>
    


     



    <div class="modal" id="defaultModal" tabindex="-1" role="dialog" aria-hidden="true"  > 
      <div class="modal-dialog" role="document">
        <div class="modal-content" >
          <div class="modal-header">
            <h5 class="modal-title"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" >
              
              
          </div>
          <div class="modal-footer">
             
          </div>
        </div>
      </div>
    </div>
    
  
    <script type="text/javascript">

      //$("#LoadingModal").modal({backdrop: 'static', keyboard: false});
      //$("#LoadingModal").modal({backdrop: 'static',

      $(function() {
          //index model display
          //$('#sampleListModal').modal("show");
          initComponents();
          renderLoginPanel();

           
          var appModel=0;


          var defaultBG = "#f5f7f7";
            var defaultNodeColor = "#B9B9B9"
            var defaultR=4;

            var scMainSvg;
            var mainXscale;
            var mainYscale;
            var mainTransform;
            var selectednodes;
          var margin;


          var clusterTable;



          //startLoading();

          var clstrs=[];


          sampleObjectId="";

          
          function renderLoginPanel(){
            //check if already login go to sample list;
            //check
            //sessionStorage.setItem('test', 'test123');

            var user = sessionStorage.getItem("username");
            var logintime = sessionStorage.getItem("logintime");
            if(logintime===null){

              logintime=0;
            }
            var currentdata = Date.now();
            var timediff = currentdata-logintime;
            
            //sessionStorage.setItem('username', 'test123');
            

            if( (user === null || user ==="") || (timediff>1000000) ||  isNaN(timediff)  ){

              //do render
              
              $("#infopanel").html("");
              renderstr="<h4 style='color:steelblue;text-align:center;'>Login</h4><br>"
              renderstr +="<div class='form-group'>";
              renderstr+="<label>Input Name:</label><input type='text' class='form-control form-control-sm' name='usernameinput'><br>";
              renderstr+="<label>Input Password:</label><input type='password' class='form-control form-control-sm' name='passwordinput'><br>";
              renderstr+="<button class='btn btn-primary btn-sm' name='loginbtn'>Login</button>";
              renderstr+="<span name='logininfo'></span>";
              renderstr+='</div>';
              $("#mainpanel").html("<div class='shadow p-3 mb-5 bg-white rounded' style='width:400px;margin: 0 auto;margin-top:18%;'>"+renderstr+"</div>");



              $("[name='loginbtn']").click(function(){

                  var username = $("[name='usernameinput']").val().trim();
                  var password =$("[name='passwordinput']").val().trim();
                  
                  
                  $.ajax({

                      url:"/userLogin",
                      data:{"username":username,"password":password},
                      method:'post',
                      dataType:"JSON",
                      success:function(data){
                        
                        var status = data.status;
                        if(status==="success"){

                          
                          sessionStorage.setItem("username",username);
                          sessionStorage.setItem("logintime",Date.now() );
                          sessionStorage.setItem("userrole",data.role );

                          renderSamleList();

                        }else{

                          $("[name='logininfo']").html("username or password not correct");


                        }

                      },error:function(){

                          $("[name='logininfo']").html("error");
                      }


                  })

                  



              })


            }else{

              //render list
              renderSamleList();


            }
          }





          function renderSamleList(){

            startLoading2();

            $.ajax({

                url:"/getSampleLists",
                data:{"userid":"userid"},
                method:'post',
                dataType:"JSON",
                success:function(data){
                  endLoading2();
                  var samples = data.samples;
                  $("#mainpanel").html("<div style='overflow-y:auto;'><ul class='list-group'</ul></div>");


                  var splistul = $("#mainpanel").find("ul")
                  for(i in samples){
                    var sp = samples[i];
                    splistul.append("<li class='list-group-item'><a value='"+sp["_id"]+"' name='linkbtn' style='color:#0d47a1;cursor:pointer;'>"+sp["name"]+"</a>,<span>"+sp["source"]+"</span>,<span>"+sp["tissue"]+"</span>,<span>"+sp["subjectid"]+"</span>,<span>"+sp["disease"]+"</span></li>");

                  }

                  clicksamplelinkforMap();


                },error:function(){

                  errorLoading2();

                }


            })




          }



          function clicksamplelinkforMap(){

            $("[name='linkbtn']").click(function(){

                sampleObjectId= $(this).attr("value");

                clstrs=[];
                
                startLoading2();
                
                $.ajax({

                    url:"/getMapDataBySampleId",
                    data:{"sampleid":sampleObjectId},
                    method:"post",
                    dataType:"JSON",
                    success:function(data){
                      var tsnedt = data.tsneData;
                      clstrs = data.clstr;

                      
                      renderTsneMap(tsnedt,"#mainpanel");

                     

                    },
                    error:function(){



                    }


                })

            });



          }




          function reloadclstrtable(clstrtable,clstrtype){
              var clstrdata = clstrs[clstrtype];
            
              var tabledata=[];
              for(var i in clstrdata){

                var marks=[];
                if("marks" in clstrdata[i]){
                  marks=clstrdata[i]["marks"]
                }
                tabledata.push({"cid":clstrdata[i]["_id"],"prerender":clstrdata[i]["prerender"] ,"name":clstrdata[i]["clstrName"],"marks":marks,"color":clstrdata[i]["color"]})
              }

              clstrtable.clear();
              clstrtable.rows.add(tabledata);
              clstrtable.draw();


          }


          function renderclstrtable(div,clstrtype){

            var userrole = sessionStorage.getItem("userrole");


            var clstrdata = clstrs[clstrtype];
            
            var tabledata=[];
            for(var i in clstrdata){

              var marks=[];
              if("marks" in clstrdata[i]){
                marks=clstrdata[i]["marks"]
              }
              tabledata.push({"cid":clstrdata[i]["_id"],"prerender":clstrdata[i]["prerender"] ,"name":clstrdata[i]["clstrName"],"marks":marks,"color":clstrdata[i]["color"]})
            }


            div.html("<br><div style='overflow-x:auto;'><table class='table display' name='clusterdetailtable' style='width:100%;font-size:12px;' setlabelname='' setlabelid=''><thead style='display :none;'> </thead><tbody> </tbody> </table></div>");
            var datatable = div.find("[name='clusterdetailtable']").DataTable( {
                "searching": false,
                "info": false,
                "ordering": false,
                "paging": false,
                "scrollX": true,
                 "columns": [
                    { data: "prerender", title: "check",width:"20px"},
                    { data: "name", title: "name"},
                    { data: "marks", title: "marks"},
                    { data: "cid", title: "more"},
                    
             
                ],
                "data":tabledata,
                "columnDefs": [
                    {
                        
                        "render": function ( data, type, row ) {

                            
                            var precheck ="F";
                            if(data===true){
                              
                              precheck="T";
                            }
                            return "<span style='cursor:pointer;color:steelblue;' ischecked='F' precheck='"+precheck+"' cid='"+row.cid+"'><i class='far fa-square'></i></span>";
                        },
                         
                        "targets": 0
                    },
                    {
                        
                        "render": function ( data, type, row ) {


                            return "<span style='color:"+row.color+"'>"+data+"</span>  ";
                        },
                        "targets": 1
                    },
                    {
                        
                        "render": function ( data, type, row ) {

                            var renderstrarr=[];
                            var index=0;
                            for(var i in data){
                              if(index >2){
                                break;
                              }
                              index+=1;
                              renderstrarr.push("<span name='tbgbtn' style='cursor:pointer;'>"+data[i]+"</span>");
                            }
                            return "<div>"+renderstrarr.join(" , ")+"</div>"

                        },
                        "targets": 2
                    },
                    {
                        
                        "render": function ( data, type, row ) {

                            return "<i style='color:#07b3de;cursor:pointer;font-size:13px;' name='expandbtn' value='F'><i class='fas fa-caret-down'></i></i>";
                        },
                         
                        "targets": 3
                    },

                ]


            });

            clusterTable = datatable;

            div.find("[name='clusterdetailtable']").on("click","[name='expandbtn']",function(){

                var thisdiv = $(this);
                var thisval = $(this).attr("value");
                var tr = $(this).parent().closest('tr');
                var row = datatable.row( tr );
                var data = row.data();
                var cid = data.cid

                if(thisval ==="F"){


                    div.find("[name='clusterdetailtable']").find("[name='expandbtn']").each(function(){

                        var thisvalue = $(this).attr("value");
                        if(thisvalue==="T"){
                            $(this).trigger("click");

                        }

                    })


                    var renderstr="<div clstrid='"+cid+"'>";

                    renderstr+="<div><button class='btn btn-sm btn-primary' name='contrastglobal' style='font-size:11px;'>Contrast</button></div>";

                    
                    var marks = data.marks;

                    var markarr=[];
                    for(var i in marks){
                      markarr.push("<span name='tbgbtn' style='cursor:pointer;'>"+marks[i]+"</span>");
                    }

                    renderstr+="<div name='markgenesall'>"

                    if(markarr.length>0){

                        renderstr+="<hr></hr><div>Mark Genes:</div>";
                        renderstr+="<div>"+markarr.join(" , ")+"</div>";

                    }

                    renderstr+="</div>"

                    
                    if(userrole==="admin"){


                        renderstr+="<hr></hr><div><button class='btn btn-sm btn-warning' name='editclstr' style='font-size:11px;display:inline-block;color:white;'><i class='fas fa-edit'></i></button>&nbsp;<button class='btn btn-sm btn-danger' name='deleteclstr' style='font-size:11px;display:inline-block;'><i class='fas fa-trash-alt'></i></button>&nbsp;<button class='btn btn-sm btn-primary' name='labeltoclstr' style='font-size:11px;display:inline-block;'>Set Label</button></div>"
                    }

                    renderstr+='</div>';

                    row.child( renderstr ).show();
                    thisdiv.attr("value","T");
                    thisdiv.html("<i class='fas fa-caret-up'></i>");
                }else{


                    row.child( "" ).hide();
                    thisdiv.attr("value","F");
                    thisdiv.html("<i class='fas fa-caret-down'></i>");
                }



            })

            div.find("[name='clusterdetailtable']").on("click","[ischecked]",function(){
                
                var thisdiv = $(this);
                var checked = thisdiv.attr("ischecked");
                var thisrow=thisdiv.parent().closest("tr");
                var dt = datatable.row(thisrow).data();
                var color = dt.color;
                var cid = dt.cid;
                var cname = dt.name;

                if(checked === "F"){

                   
                    $.ajax({
                        url:"/queryClstrCellsAndLabelByCid",
                        data:{"cid":cid},
                        method:"post",
                        dataType:"JSON",
                        
                        success:function(res){

                          var cellids = res.cellids;
                          for(var i in cellids){

                            d3.select("#g"+cellids[i]).attr("clstr",cname).style("fill",color);

                          }
                          
                          thisdiv.html("<i class='far fa-check-square'></i>");
                          thisdiv.attr("ischecked","T");

                          var islabeled = res.labeled;

                          if(islabeled  === true){
                            var x2 = res["x"];
                            
                            var y2 = res["y"];
                            var name = res["name"];
                             
                            scMainSvg.append("text").attr("class","clstrlabel").attr("name","clstr"+cid).text(name).attr("x",mainXscale(x2)+margin).attr("y",mainYscale(y2)+margin);
                          }


                        },
                        error:function(){

                          alert("error")

                        }


                    })


                }else if(checked === "T"){

                    $(".node[clstr='"+cname+"']").css("fill",defaultNodeColor).removeAttr("clstr");
                    thisdiv.html("<i class='far fa-square'></i>");

                    thisdiv.attr("ischecked","F");
                    $("[name='clstr"+cid+"']").remove();
                }

                




            });


            div.find("[name='clusterdetailtable']").on("click","[name='editclstr']",function(){

                var cid = $(this).closest("[clstrid]").attr("clstrid");
                var thistr = div.find("[name='clusterdetailtable']").find("[cid='"+cid+"']").closest("tr");

                var dt = datatable.row(thistr).data();
                
                var cname =dt.name;
                var thismarks = dt.marks;
                var prechecked = dt.prerender;
                
                rendereditmodal(cid,cname,thismarks,prechecked);

            });


            div.on("click","[name='labeltoclstr']",function(){
            

                appModel="editor";

                var cid = $(this).closest("[clstrid]").attr("clstrid");
                var thistr = div.find("[name='clusterdetailtable']").find("[cid='"+cid+"']").closest("tr");

                var dt = datatable.row(thistr).data();
                
                var cname =dt.name;

                div.find("[setlabelname]").attr("setlabelname",cname);

                div.find("[setlabelid]").attr("setlabelid",cid);




            })



            div.on("click","[name='contrastglobal']",function(){
                //targetdiv.find("[name='contrastbtn']").click(function(){

                
                var cid = $(this).closest("[clstrid]").attr("clstrid");
                docontrast2(cid,"ALL");

              
            });



            div.on("click","[name='deleteclstr']",function(){
            
                var cid = $(this).closest("[clstrid]").attr("clstrid");
                var thistr = div.find("[name='clusterdetailtable']").find("[cid='"+cid+"']").closest("tr");

                var dt = datatable.row(thistr).data();
                
                var cname =dt.name;

                var thisrow = datatable.row(thistr);
                

                $("#defaultModal").find(".modal-title").html("");
                //$("#defaultModal").find(".modal-footer").html("");

                //$("#defaultModal").find(".modal-header").hide();


                $("#defaultModal").find(".modal-body").html("<span>Delete Cluster <b>"+cname+"</b>?</span> &nbsp;&nbsp; <span class='btn btn-sm btn-danger' name='yes'>Yes</span>&nbsp;&nbsp;<span class='btn btn-sm btn-secondary' name='no'>No</span>")
                $("#defaultModal").modal("show");


                $("#defaultModal").find("[name='no']").click(function(){

                    $("#defaultModal").modal("hide");

                });

                
                $("#defaultModal").find("[name='yes']").click(function(){
                    $.ajax({
                          url:"/deleteCluster",
                          data:{ "clstrid":cid },
                          method:"post",
                          dataType:"JSON",
                          success:function(data){
                            
                              $("#defaultModal").modal("hide");

                              thisrow.remove().draw();
                              
                              $(".node[clstr='"+cname+"']").removeAttr("clstr").css("fill",defaultNodeColor);
            
                              $("#mainsvg").find("[name='clstr"+cid+"']").remove();

                              
                          },
                          error:function(){


                              alert("save error")
                          }



                    });
                    

                });

                
              
            })



            //disable
            div.on("click","[name='contrastwithselected']",function(){


                var cellids = selectednodes.join(",");
                //docontrast2(cellids,"ALL");
                var cid = $(this).parent().parent().find("[cid]").attr("cid");
                docontrast(cellids,cid);



            });



            autocheckClusters(div.find("[name='clusterdetailtable']"));

             
            return datatable;


          }


          function rendereditmodal(clstrid,cname,thismarks,prechecked){

                $("#defaultModal").modal("show");


                $("#defaultModal").find(".modal-title").html("Cluster Editor");
                $("#defaultModal").find(".modal-footer").html("");
                     

                var modalbody = $("#defaultModal").find(".modal-body");

                //new cluster name
                modalbody.html("<div>New cluster name:</div><div name='newnameinputdiv' class='input-group'><input name='newnameinput' class='form-control' type='text' placeholder='"+cname+"'><div class='input-group-append'><span class='input-group-text btn savebtn'>save</span></div></div>");

                var iconstr="<i class='far fa-square'></i>";
                var precheckedstr="F";
                if(prechecked===true){
                  iconstr="<i class='far fa-check-square'></i>";
                  precheckedstr="T";
                }

                modalbody.append("<br><div><span style='color:steelblue;cursor:pointer;'  isprecheck='"+precheckedstr+"'>"+iconstr+"</span>&nbsp;&nbsp;<span>Precheck</span></div>");

                modalbody.append("<br><div><div>Gene Marks:</div><div name='marksinputdiv' class='input-group'><input name='marksinput' class='form-control' type='text' value='"+thismarks.join(",")+"'></input><div class='input-group-append'><span class='input-group-text btn markssavebtn'>save</span></div></div></div>");

                modalbody.find("[isprecheck]").click(function(){

                    var isprechecksetdiv=$(this);
                    var val = $(this).attr("isprecheck");
                    var newval=""
                    if(val ==="F"){
                      newval="T"; 

                    }else if(val==='T'){
                      newval='F';

                    }

                    if(newval !==""){

                        $.ajax({
                                  url:"/updatecluster",
                                  data:{"target":"prerender","clstrid":clstrid,"val":newval},
                                  method:"post",
                                  dataType:"JSON",
                                  success:function(data){
                                      isprechecksetdiv.attr("isprecheck",newval);
                                      if(newval==="T"){

                                          isprechecksetdiv.html("<i class='far fa-check-square'></i>")

                                      }else if(newval==="F"){

                                          isprechecksetdiv.html("<i class='far fa-square'></i>")

                                      }
                                     
          
                                  },
                                  error:function(){


                                      alert("save error")
                                  }



                        })

                    }


                });

                modalbody.find("[name='marksinputdiv']").find(".markssavebtn").click(function(){


                    var marks= modalbody.find("[name='marksinputdiv']").find("[name='marksinput']").val();
                    marks = marks.trim();
                    if(marks.length>0 ){
                        $.ajax({
                                  url:"/updatecluster",
                                  data:{"target":"MARKS","clstrid":clstrid,"marks":marks},
                                  method:"post",
                                  dataType:"JSON",
                                  success:function(data){
                                    
                                    $("#defaultModal").modal("hide");
                                    
                                    
                                    var thistr = $("#clustersInfo").find("[name='clusterdetailtable']").find("[cid='"+clstrid+"']").closest("tr");
                                    var row = clusterTable.row(thistr);
                                    var dt = row.data();
                                    dt.marks = marks.split(",");

                                    
                                    row.data(dt).draw();

                                    //change marks
                                    
                                  },
                                  error:function(){


                                      alert("save error")
                                  }



                        }) 

                    }


                });

                modalbody.find("[name='newnameinputdiv']").find(".savebtn").click(function(){


                          var newname = modalbody.find("[name='newnameinputdiv']").find("[name='newnameinput']").val();
                          newname = newname.trim();
                          if(newname.length>0 && (newname !==cname)){
                              $.ajax({
                                  url:"/updatecluster",
                                  data:{"target":"NAME","clstrid":clstrid,"name":newname},
                                  method:"post",
                                  dataType:"JSON",
                                  success:function(data){
                                    
                                    $("#defaultModal").modal("hide");
                                    $("#mainsvg").find("[name='clstr"+clstrid+"']").text(newname);
                                    
                                    var thistr = $("#clustersInfo").find("[name='clusterdetailtable']").find("[cid='"+clstrid+"']").closest("tr");
                                    var row = clusterTable.row(thistr);
                                    var dt = row.data();
                                    dt.name = newname;

                
                                    row.data(dt).draw();

          
                                  },
                                  error:function(){


                                      alert("save error")
                                  }



                              }) 

                          }

                });


                //modalbody


          }

          function autocheckClusters(clustertable){
              
              var checkedcid =[];
              clustertable.find("[precheck='T']").each(function(){
                  var thisdiv= $(this);
                  var cid = $(this).attr("cid");
                  var precheck=$(this).attr("precheck");
                  if(precheck==="T"){
                    checkedcid.push(thisdiv);
                  }
                  

              });

              if(checkedcid.length  >0){

                  for(var i in checkedcid){

                    checkedcid[i].trigger("click");

                }

              }

                

          }

          
          function clearAllNodes(){

            $(".node").css("fill",defaultNodeColor);//.removeAttr("clstr");
            $("#genesearch").find("[name='genesearchdetails']").find("[name='genesearchplot']").html("");
            //$("#clustersInfo").find("[cid]").html("<i class='far fa-square' style='color: steelblue;cursor:pointer;'></i>");



          }
          function clearClusterState(){

            $(".node[clstr]").css("fill",defaultNodeColor).removeAttr("clstr");
            $(".clstrlabel").remove();

          }

          function renderInfoPanel(div_id){

            

            var panelstr='<ul class="nav nav-tabs controlpanel">';
              panelstr+='<li class="nav-item">';
                panelstr+='<a class="nav-link active" data-toggle="tab" href="#genesearch">Gene Search</a>';

              panelstr+='</li>';
              panelstr+='<li class="nav-item">';
                panelstr+='<a class="nav-link" data-toggle="tab" href="#clustersInfo">Clusters</a>';
              panelstr+='</li>';
               
            panelstr+='</ul>';


            panelstr+='<div class="tab-content">';
              panelstr+='<div id="genesearch" class="tab-pane active"><br><div name="tabcontent"></div>';

              panelstr+='</div>';

              panelstr+='<div id="clustersInfo" class="tab-pane fade"><br><div name="tabcontent"></div>';

              panelstr+='</div>';

              
            panelstr+='</div>';
            

            $(div_id).html(panelstr);




            
            var genesearchpanel = $(div_id).find("#genesearch").find("[name='tabcontent']");


            var clusterpanel = $(div_id).find("#clustersInfo").find("[name='tabcontent']");
            
            var calculationpanel = $(div_id).find("#clstrcalculation").find("[name='tabcontent']");
            
            
            //alert(JSON.stringify(clstrs))

            clusterpanel.html("<div name='sellectcelldiv' style='height:28px;'>Select cells on the left to start cluster analysis.</div><hr></hr><div><select name='clsterswitch' class='form-control form-control-sm'></select></div><div name='clstrdetail'> </div>");
            //

            var clsterswitch = clusterpanel.find("[name='clsterswitch']");
            for(var  i in clstrs){

              clsterswitch.append("<option value='"+i+"'>"+i+"</option>");

            }
            

            var clstrDatatable = renderclstrtable( clusterpanel.find("[name='clstrdetail']"),clsterswitch.val());


            clsterswitch.on("change",function(){


                var val = $(this).val();
                clusterpanel.find("[clstrtype]").hide();
                clusterpanel.find("[clstrtype='"+val+"']").show();
                clearClusterState();

                reloadclstrtable(clstrDatatable,val);

                autocheckClusters( clusterpanel.find("[name='clstrdetail']") );
                
            });
            

            //genesearch

            genesearchpanel.html("<textarea name='genesearcharea' rows='4' style='width:100%;max-width:200px;'></textarea><br>")
            genesearchpanel.append("<button name='genesearchbtn' class='btn btn-primary btn-sm'>search</button><hr></hr><div name='genesearchdetails'></div>")
            
            genesearchpanel.find("[name='genesearchbtn']").click(function(){
              var genestr = genesearchpanel.find("[name='genesearcharea']").val();
              genestr = genestr.replace(/ /gi,"").replace(/\n/gi,",").toUpperCase();

              if(genestr.length>0){
                  clearAllNodes();

                  $.ajax({

                      url:"/genelistSearch",
                      data:{"sampleid":sampleObjectId,"genestr":genestr},
                      method:"post",
                      dataType:"JSON",
                      success:function(res){
                         

                        var data= res.res;
                        var geneCount = res.count;

                        if(geneCount===1){

                          var gene = res.gene;
                          var maxval = res.maxval;

                          
                          var redscale = d3.scaleLinear()
                                    .domain([0,maxval])
                                    .range(["#ff8080", "#800000"]);

                           

                          //var redscale =d3.scaleSequential(d3["interpolateReds"]).domain([0, maxval]);

                          for(i in data){
                            d3.select("#g"+i).style("fill",redscale(data[i]));


                          }

                          genesearchpanel.find("[name='genesearchdetails']").html("<div name='genesearchplot'></div>");
                          renderGenesearchPlot(genesearchpanel.find("[name='genesearchdetails']").find("[name='genesearchplot']"),gene);
                        }else if(geneCount ===0){

                          genesearchpanel.find("[name='genesearchdetails']").html("gene not found");


                        }else if(geneCount ===2){
                            

                            genesearchpanel.find("[name='genesearchdetails']").html("<svg id='twogeneplot' style='width:100%;height:160px;' ></svg><hr></hr><div name='genesearchplot'></div>");
                            
                            //render plot
                            var totalw = Math.floor($("#twogeneplot").width());

                            let g1 = data["g"][0];
                            let g2 = data["g"][1];
                            let g3 = "intersection";

                            let c1 = data["c"][0];
                            let c2 = data["c"][1];
                            let c3 = data["c"][2];

                            var maxlength = Math.max(c1,c2)+c3;
                             
                            let circleRLinear = d3.scaleLinear().domain([0,maxlength]).range([4,(140-10)/4]);

                            var r1;
                            var r2;
                            var r3;
                            if(c1===0){
                              r1=0;
                            }else{

                              r1 = circleRLinear(c1);
                            }

                            if(c2===0){
                              r2=0;
                            }else{

                              r2 = circleRLinear(c2);
                            }

                            if(c3===0){
                              r3=0;
                            }else{

                              r3 = circleRLinear(c3);
                            }
                            let dt1 = data["d1"] ;
                            let dt2 = data["d2"] ;
                            let dt3 = data["d3"] 

                            let g = d3.select("#twogeneplot").append("g");
                            g.append("line")
                            .attr("x1",50)
                            .attr("x2",50)
                            .attr("y1",0)
                            .attr("y2",150)
                            .attr("stroke-width",1)
                            .attr("stroke","black")

                            g.append("line")
                            .attr("x1",40)
                            .attr("x2",220)
                            .attr("y1",140)
                            .attr("y2",140)
                            .attr("stroke-width",1)
                            .attr("stroke","black");


                            g.append("circle")
                              .attr("r",r1)
                              .attr("g",g1)
                              .attr("cx",50+ 180/4)
                              .attr("cy",140/4)
                              .style("fill","red")
                              .style("stroke","red")
                              .on("mouseover",function(){

                                let gname = g1;
                                let cellids = dt1;
                                let celllen = c1;
                                pagex = d3.event.pageX;
                                pagey = d3.event.pageY;

                                let form = "<div>";

                                if(c1>1){

                                  form+="<h5 style='white-space:nowrap;'>"+gname+" (only).</h5>";


                                }
                                form+="<h5 style='white-space:nowrap;'>"+c1+" </h5>"
                                form+="</div>";
                                
                                d3.select("#tooltip").style("opacity",.9)
                                  .style("left",(pagex+30)+"px")
                                  .style("left",(pagey-100)+"px")
                                  .html(form)

                                
                              });

                              g.append("circle")
                              .attr("r",r2)
                              .attr("g",g2)
                              .attr("cx",50+ 3*180/4)
                              .attr("cy",3* 140/4)
                              .style("fill","green")
                              .style("stroke","green")
                              .on("mouseover",function(){

                                let gname = g2;
                                let cellids = dt2;
                                let celllen = c2;
                                pagex = d3.event.pageX;
                                pagey = d3.event.pageY;

                                let form = "<div>";

                                if(gname.length>=1){

                                  form+="<h5 style='white-space:nowrap;'>"+gname+" (only).</h5>";


                                }
                                form+="<h5 style='white-space:nowrap;'>"+c2+" </h5>"
                                form+="</div>";
                                
                                d3.select("#tooltip").style("opacity",.9)
                                  .style("left",(pagex+30)+"px")
                                  .style("left",(pagey-100)+"px")
                                  .html(form)

                                
                              });


                              g.append("circle")
                              .attr("r",r3)
                              .attr("g",g3)
                              .attr("cx",50+ 3*180/4)
                              .attr("cy", 140/4)
                              .style("fill","yellow")
                              .style("stroke","yellow")
                              .on("mouseover",function(){

                                let gname = g3;
                                let cellids = dt3;
                                let celllen = c3;
                                pagex = d3.event.pageX;
                                pagey = d3.event.pageY;

                                let form = "<div>";

                                if(gname.length>=1){

                                  form+="<h5 style='white-space:nowrap;'>"+gname+" .</h5>";


                                }
                                form+="<h5 style='white-space:nowrap;'>"+c3+" </h5>"
                                form+="</div>";
                                
                                d3.select("#tooltip").style("opacity",.9)
                                  .style("left",(pagex+30)+"px")
                                  .style("left",(pagey-100)+"px")
                                  .html(form)

                                
                              });


                              g.append("text")
                                .text(g1)
                                .attr("name","fitedgene")
                                .attr("text-anchor","middle")
                                .attr("transform","translate(35,60) rotate(-90)" )
                                .style("cursor","pointer");

                              g.append("text")
                                .text(g2)
                                .attr("x",50+180/2)
                                .attr("y",160) 
                                .attr("name","fitedgene")
                                .attr("text-anchor","middle")
                                .style("cursor","pointer");



                        }else{

                          genesearchpanel.find("[name='genesearchdetails']").html("<table name='genesearchrestable' class='display table table-striped table-bordered compact' style='width:100%;'><thead style='display:none;'><tr><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody style='font-size:11px;'></tbody></table><hr></hr><div name='genesearchplot'></div>");

                          

                          var index =0;
                          var tablestr ="";
                          for(var i in data){
                            if(index===0){
                              tablestr+='<tr>';
                            }

                            tablestr+="<td><span name='fitedgene' style='cursor:pointer;'>"+data[i]+"</span></td>"

                            index+=1;
                            if(index ===6){

                              tablestr+='</tr>';
                              index = 0;
                            }



                          }


                          if(index!==0){
                            for(var i=index;i<6;i++){

                                tablestr+="<td></td>"
                            }
                            tablestr+='</tr>'

                          }

                          genesearchpanel.find("[name='genesearchrestable']").find("tbody").html(tablestr);

                          genesearchpanel.find("[name='genesearchrestable']").DataTable( {
                              searching: false,
                              info: false,
                              "ordering": false,
                              "pageLength": 5,
                              "lengthChange": false,
                               
                              "pagingType": "simple",
                              "scrollX": true

                          })


                          

                        }


                        genesearchpanel.on("click","[name='fitedgene']",function(){

                            var newgstr = $(this).text();
                            var newdiv= $(this);
                            $.ajax({

                                url:"/genelistSearch",
                                data:{"sampleid":sampleObjectId,"genestr":newgstr},
                                method:"post",
                                dataType:"JSON",
                                success:function(res2){

                                  genesearchpanel.find("[name='fitedgene']").css("color","black").attr("genechecked","F");
                                  newdiv.css("color","steelblue").attr("genechecked","T");


                                  $(".node").css("fill",defaultNodeColor);//.removeAttr("clstr");
                                  var newdt = res2.res;
                                  var maxval = res2.maxval;


                                 
                                  var redscale = d3.scaleLinear()
                                    .domain([0,maxval])
                                    .range(["#ff8080", "#800000"]);

                                  

                                  //var redscale =d3.scaleSequential(d3["interpolateReds"]).domain([0, maxval]);


                                  for(i in newdt){
                                    d3.select("#g"+i).style("fill",redscale(newdt[i]) );


                                  }


                                  renderGenesearchPlot(genesearchpanel.find("[name='genesearchdetails']").find("[name='genesearchplot']"),newgstr);


                                },error:function(){

                                  alert("server error")
                                }

                            });


                        })
                        
                        



                      },
                      error:function(){



                      }



                  })

              }


            })
            
            //gene serch btn end

            $(".controlpanel").on('shown.bs.tab', function(event){

                //var active_tab = $(event.target).text();
                //var previous_tab = $(event.relatedTarget).text();
                var active_tab = $(event.target).attr("href");
                if(active_tab ==="#clustersInfo"){

                    clearAllNodes();
                    var thisdiv = $("#clustersInfo").find("[name='clusterdetailtable']");
                    thisdiv.find("[ischecked='T']").each(function(){
                       $(this).trigger("click");
                       $(this).trigger("click");


                   })

                }else if(active_tab ==="#genesearch"){

                    var temp = $("#genesearch").find("[name='fitedgene'][genechecked='T']");
                    if(temp.length===1){

                        temp.trigger("click");

                    }else{

                        if($("#genesearch").find("[name='genesearchrestable']").length===1){

                        }else{

                            $("#genesearch").find("[name='genesearchbtn']").trigger("click");
                        }
                    
                    

                    }
                }



            });

            $("#clustersInfo").on('shown.bs.tab', function(){

                 
                 clearAllNodes();
                 thisdiv.find("[ischecked='T']").each(function(){
                    var cid = $(this).attr("cid");
                    var color = $(this).parent().find("[cname]").css("color");
                    var cname = $(this).parent().find("[cname]").attr("cname");
                    $(".node[clstr='"+cname+"']").css("fill",color);


                 })


            });


          

          }//render info panel


  
 


          function renderTsneMap(data,div_id){


            $(div_id).css("background",defaultBG).html("");

            var width = $(div_id).width();
            var height = $(div_id).height();

            

            margin = 20;
            var size = Math.floor(d3.min([width,height]));
            size = size- 2*margin ;
            
            scMainSvg = d3.select(div_id).append('svg').attr("id","mainsvg")
              .attr('width', width )
              .attr('height', height );


            //scMainSvg.append("rect").attr("x",0).attr("y",0).attr("width",100).attr("height",100).style("fill","#777777")


            
            var xrange=[0,0];
            var yrange=[0,0];
            for(var i in data){
              let tempx = data[i].x;
              let tempy = data[i].y;
              
              if(tempx < xrange[0]){
                xrange[0]=Math.floor(tempx);
              }else if(tempx > xrange[1]){
                xrange[1]=Math.ceil(tempx);
              }

              if(tempy < yrange[0]){
                yrange[0]=Math.floor(tempy);
              }else if(tempy > yrange[1]){
                yrange[1]=Math.ceil(tempy);
              }

            }


            


            mainXscale = d3.scaleLinear()
            .domain(xrange)
            .range([0, size]);



            mainYscale = d3.scaleLinear()
            .domain(yrange)
            .range([size, 0]);

            renderNodes()
            //data=null;

            function renderNodes(){

              setTimeout(function(){
                var count=1500;

                while(count >0 && data.length>0){
                  count-=1;
                  var datalength = data.length;
                  var i = datalength-1;

                  var gid = "g"+data[i]["order"];
                  var x = mainXscale(data[i].x)+margin;
                  var y = mainYscale(data[i].y)+margin;
                  data.pop();

                  scMainSvg.append("circle").attr("id",gid).attr("class","node").attr("cx",x).attr("cy",y).attr("r",defaultR)
                      .style("fill",defaultNodeColor)
                      .style("fill-opacity",0.5)
                      .style("stroke-width",0.5)
                      .style("stroke","white");

                  if(data.length>0){


                    renderNodes();
                  }else{

                    renderInfoPanel("#infopanel");

                    renderActions();
                    endLoading2();

                  }

                }





              },1)

            }
            //alert(JSON.stringify(data)
            
            function renderActions(){
              selectednodes=[];

              var coords =[];
              var selectedline =d3.line();
              //var ori_coords=[];

              var cell_nodes=d3.selectAll(".node");

              var dragStart = function(){

                cell_nodes.classed("selected", false);

                coords = [];
                   
                d3.selectAll(".node_draw_path").remove();
                d3.selectAll(".node_done_path").remove();
                  
                cell_nodes.style("stroke","white").style("stroke-width",0.5);
                  
                
                //renderfunction
                $("#clustersInfo").find("[name='sellectcelldiv']").html("Select cells on the left to start cluster analysis.");

                $("#clustersInfo").find("[name='contrastwithselected']").hide();

              }
              var drawPath = function(isdone) {
                if(coords.length>1){


                  scMainSvg.append("path").attr("class",'node_draw_path').attr( "d",selectedline([coords[coords.length-2],   coords[coords.length-1] ]));

                  if (isdone) {

                    coords = coords.concat([coords[0]]);

                    scMainSvg.append("path").attr("class","node_done_path").attr("d", selectedline(coords ) );

                    scMainSvg.selectAll(".node_draw_path").remove();


                    cell_nodes.each(function(d, i) {
                      point = [d3.select(this).attr("cx"), d3.select(this).attr("cy")];
                      if (pointInPolygon(point, coords)) {
                        d3.select(this).classed("selected", true);

                      }

                    });

                    selectPath();
                  }

                }
              }

              var selectPath = function(){


                let templen =$(".node.selected").length;

                if(templen>0){

                  selectednodes = [];
                  $(".node.selected").each(function(){
                    selectednodes.push(Number($(this).attr("id").substring(1)));
                    
                    $(this).css("stroke","#278BC5").css("stroke-width",1);;
                  })

                  execafterselected(selectednodes);
                  
                  
                }else{
                  $(".node").css("stroke","white").css("stroke-width",0.5);
                    //$("[name='cellselectinfo']").html("");
                  dragStart();

                }
              }


              var dragMove = function() {
                cell_nodes.classed("selected", false);
                let tempcoord = d3.mouse(this);

                if(coords.length>0){
                  let lastcoord = coords[coords.length-1];
                  if(Math.abs(lastcoord[0]-tempcoord[0])+ Math.abs(lastcoord[1]-tempcoord[1]) >2){
                    coords.push(tempcoord);
                    drawPath();

                  }
                }else{
                  coords.push(tempcoord);
                  drawPath();
                }

              }
                

              var dragEnd = function() {
                drawPath(true);

              }

              svgDrag = d3.drag().on("start", dragStart).on("drag", dragMove).on("end", dragEnd);
              scMainSvg.call(svgDrag)


            }
           

            //drag end;


            //

            scMainSvg.on("dblclick",function(){

                if(appModel==="editor"){

                    var coordinates = [0, 0];
                    coordinates = d3.mouse(this);
                    var x = coordinates[0];
                    var y = coordinates[1];


                    x = x-margin;
                    y = y-margin;

                    
                    var x2 = mainXscale.invert(x);
                    var y2 =  mainYscale.invert(y);



                    $("#defaultModal").modal("show");


                    $("#defaultModal").find(".modal-title").html("");
                    $("#defaultModal").find(".modal-footer").html("");
                     

                    var modalbody = $("#defaultModal").find(".modal-body");
                    
                    modalbody.html("<div>Set Cluster Label here?  &nbsp;&nbsp; <span class='btn btn-sm btn-success' name='yes'>Yes</span>&nbsp;&nbsp;<span class='btn btn-sm btn-secondary' name='no'>No</span></div>");

                    var setlabelname = $("#clustersInfo").find("[setlabelname]").attr("setlabelname");
                    var setlabelid = $("#clustersInfo").find("[setlabelid]").attr("setlabelid");
                    modalbody.find("[name='no']").click(function(){


                        //appModel=0;

                        //$("#clustersInfo").find("[setlabelname]").attr("setlabelname");

                        $("#defaultModal").modal("hide");

                    });

                    modalbody.find("[name='yes']").click(function(){

                        var clstrid =setlabelid;
                        var clstrText = setlabelname;
                        $.ajax({
                            url:"/updatecluster",
                            data:{"target":"POS","clstrid":clstrid,"x":Number(x2),"y":Number(y2)},
                            method:"post",
                            dataType:"JSON",
                            success:function(data){
                              
                               $("#defaultModal").modal("hide");

                                scMainSvg.append("text").attr("class","clstrlabel").attr("name","clstr"+clstrid).text(clstrText).attr("x",mainXscale(x2)+margin).attr("y",mainYscale(y2)+margin);

                                appModel=0;
                                $("#clustersInfo").find("[setlabelname]").attr("setlabelname","");
                                $("#clustersInfo").find("[setlabelid]").attr("setlabelid","");
                            },
                            error:function(){


                                alert("save error")
                            }



                        }) 


                        

                    });

                    
                    modalbody.find("[name='setclstrlabelhere']").click(function(){
                      var clstrid = modalbody.find("[name='saveclstrposselect']").val();
                      var clstrText = tempdata2[clstrid];
                      
                       
                      $.ajax({
                          url:"/updatecluster",
                          data:{"target":"POS","clstrid":clstrid,"x":Number(x2),"y":Number(y2)},
                          method:"post",
                          dataType:"JSON",
                          success:function(data){
                            
                             $("#defaultModal").modal("hide");

                              scMainSvg.append("text").attr("class","clstrlabel").attr("name","clstr"+clstrid).text(clstrText).attr("x",mainXscale(x2)+margin).attr("y",mainYscale(y2)+margin);
  
                          },
                          error:function(){


                              alert("save error")
                          }



                      }) 

                      

                      
                    });

                     

                }
                  
                  
            })

              
    



          }//renderactions



          pointInPolygon = function (point, vs) {
            // ray-casting algorithm based on
            // http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html
            var xi, xj, i, intersect,
                x = point[0],
                y = point[1],
                inside = false;
            for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
              xi = vs[i][0],
              yi = vs[i][1],
              xj = vs[j][0],
              yj = vs[j][1],
              intersect = ((yi > y) != (yj > y))
                  && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
              if (intersect) inside = !inside;
            }
            return inside;
          }


          
          function renderGenesearchPlot(div,gene){
            

            div.html("<div name='barsvgselection'></div><div id='barsvgdiv'></div>")


            var selectstr="<select name='plotclstrselection'>";

            if("cellType" in clstrs){

              selectstr+="<option value='cellType'>cellType</option>";
            }

            for(var i in clstrs){

              if(i!=="cellType"){

                selectstr+="<option value='"+i+"'>"+i+"</option>";
              }

            }

            selectstr+="</select>";


            div.find("[name='barsvgselection']").html("<h6>"+gene+" &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "+selectstr+" </h6>")


            var barplotdata=null;

            div.find("[name='barsvgselection']").find("[name='plotclstrselection']").on("change",function(){

                var value = $(this).val();
                var data2=[];
                for(var i in barplotdata){
                    if(barplotdata[i]["ctype"]===value){
                      data2.push(barplotdata[i])
                    }
                    
                }

                renderBarplot("#barsvgdiv",data2,false);



            });

            var currentclstr = div.find("[name='barsvgselection']").find("[name='plotclstrselection']").val();

            
            var plotdiv = $("#barsvgdiv");
            startLoadingDiv(plotdiv)
            

            $.ajax({

              url:"/getGeneSearchPlotData",
              data:{"gene":gene,spid:sampleObjectId},
              method:'post',
              dataType:"JSON",
              success:function(data){
                  endLoadingDiv(plotdiv);

                  barplotdata = data.data;

                  var data2=[];
                  for(var i in barplotdata){
                    if(barplotdata[i]["ctype"]===currentclstr){
                      data2.push(barplotdata[i])
                    }
                    
                  }
                  
                  renderBarplot("#barsvgdiv",data2,false);
                  

              },error:function(){

                  endLoadingDiv(div);

              }



            })



          }
          

          function renderBarplot2(div,data,geneName,issort){
            var minv=Infinity;
            var maxv =0;

            if(issort){



            
              for(var i=0;i<data.length;i++){

                for(var j=i;j<data.length;j++){

                  var val1 = data[i]["median"];
                  var val2 = data[j]["median"];

                  if(val2 > val1){
                    temp =  data[i];
                    data[i]=data[j];
                    data[j]=temp;
                    

                  }
                }

              }

            }
            for(var i=0;i<data.length;i++){

              var tempmax = data[i]["max"];
              var tempmin = data[i]["min"];

              if(tempmin<minv){
                minv = tempmin;
              }
              if(tempmax>maxv){
                maxv = tempmax;
              }

              

            }


            var divwidth = $(div).width();

            var barmargin={ right:13,bottom:100,top:9, left:50};
            var gap =20;
            var width =  Math.ceil(divwidth - 2*barmargin.left - 2*barmargin.right-gap);
            var height = 150;
            var barheight =height;
            
            var barwidth = (width)/2;
             

            $(div).html("<h6>"+geneName+"</h6>");
            var svg = d3.select(div).append("svg").attr("id",'barsvg')
              .attr("width", width +  2*barmargin.left +  2*barmargin.right+gap)
              .attr("height", height +  barmargin.top + barmargin.bottom);

            var maxmedian=0;
            var labels=[];

            for(var i in data){

              median = data[i]["median"];
              if(median > maxmedian){

                maxmedian = median;
              }

              labels.push(data[i]["name"])


            }


            var xliner = d3.scaleLinear()
                .domain([0, labels.length+1 ])
                .range([0, barwidth]);


            var yliner1 = d3.scaleLinear()
                .domain([0, 1])
                .range([barheight,0]);



            var yliner2 = d3.scaleLinear()
                .domain([minv, maxv])
                .range([barheight,0]);

            var xAxis = d3.axisBottom(xliner).tickFormat("").ticks(labels.length+1);
            var yAxis1 = d3.axisLeft(yliner1);
            var yAxis2 = d3.axisLeft(yliner2);

            var barg = svg.append("g").attr("id","barg").attr("transform",  "translate("+barmargin.left+"," + (barmargin.top) + ")");
            svg.append('g').attr("transform",  "translate("+barmargin.left+"," +  barmargin.top + ")").call(yAxis1);
            svg.append('g').attr("transform",  "translate("+(2*barmargin.left+barwidth+gap)+"," +barmargin.top + ")").call(yAxis2); 

            svg.append('g').attr("transform", "translate("+barmargin.left+"," + (barheight+barmargin.top) + ")").call(xAxis);
            svg.append('g').attr("transform", "translate("+(2*barmargin.left+barwidth+gap)+"," + ( barmargin.top+barheight) + ")").call(xAxis);

            for(var i=0;i<labels.length;i++){
              

              barg.append("g").attr("class","xlabel2").attr("transform", "translate("+xliner(i+1)+"," + (barheight) + ")")
                .append("text").text(labels[i]).style("text-anchor", "end")
                      .attr("dx", "-.8em")
                      .attr("dy", ".15em")
                      .style("font-size",10)
                      .attr("transform", "rotate(-90)");


              barg.append("g").attr("class","xlabel2").attr("transform", "translate("+(xliner(i+1)+barwidth+gap)+"," + ( barheight ) + ")")
                .append("text").text(labels[i]).style("text-anchor", "end")
                      .attr("dx", "-.8em")
                      .attr("dy", ".15em")
                      .style("font-size",10)
                      .attr("transform", "rotate(-90)");


            }


            var plot1y = barheight;
            var plot2y = 0 ;
            var barwidthx = barwidth/data.length/2;
            var boxwidthx = barwidthx;
            var hf_boxwidth = barwidthx/2
            if(barwidthx> 35){
              barwidthx =35;
            }
            for(var i=0;i<data.length;i++){

              var color = data[i]["color"];
              var percval =data[i]["perc"];
              var barh1 = yliner1(percval);
              barh1 = barheight-barh1;

              var y1 = plot1y-barh1
              var x1 = xliner(i+1)-(barwidthx/2);

              var boxx1 = xliner(i+1)-(hf_boxwidth)+gap+barwidth+barmargin.left;
              var boxx2 = xliner(i+1)+(hf_boxwidth)+gap+barwidth+barmargin.left;

              barg.append("rect").attr("x",x1).attr("y",y1).attr("width",barwidthx).attr("height",barh1).style("fill",color);


              var min= yliner2(data[i]["min"]);
              var max = yliner2(data[i]["max"]);
              var median = yliner2(data[i]["median"]);
              var q1 = yliner2(data[i]["1q"]);
              var q3 = yliner2(data[i]["3q"]);
              //alert(medianval)

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+median)
                .attr("y2",plot2y+median)
                .style("stroke-width",1);


              
              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+max)
                .attr("y2",plot2y+max)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+min)
                .attr("y2",plot2y+min)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+q1)
                .attr("y2",plot2y+q1)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+q3)
                .attr("y2",plot2y+q3)
                .style("stroke-width",1);


              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx1)
                .attr("y1",plot2y+q1)
                .attr("y2",plot2y+q3)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx2)
                .attr("x2",boxx2)
                .attr("y1",plot2y+q1)
                .attr("y2",plot2y+q3)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1", (xliner(i+1)+gap+barwidth+barmargin.left)  )
                .attr("x2", (xliner(i+1)+gap+barwidth+barmargin.left) )
                .attr("y1",plot2y+max)
                .attr("y2",plot2y+q3)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1", (xliner(i+1)+gap+barwidth+barmargin.left) )
                .attr("x2", (xliner(i+1)+gap+barwidth+barmargin.left) )
                .attr("y1",plot2y+q1)
                .attr("y2",plot2y+min)
                .style("stroke-width",1);

              barg.append("rect")
                .style("fill",color)
                .style("fill-opacity",0.5)
                .attr("x",boxx1)
                .attr("y",plot2y+q3)
                .attr("height",   q1-q3)
                .attr("width",2*hf_boxwidth)



            }//for

            var label1= svg.append("g").attr("class","boxbar").attr("transform", "translate( "+(2*barmargin.left+gap+barwidth-40)+","+(barmargin.top+barheight/2)+" ) rotate(-90)")
            .append("text").text("Counts").style("font-size","13")
              .attr("text-anchor", "middle");
              //.attr("x",barmargin.left-30).attr("y",barmargin.top+barheight/2);//;
            var label2= svg.append("g").attr("class","percbar").attr("transform", "translate( "+(barmargin.left-35)+" , "+(barmargin.top+barheight/2)+" ) rotate(-90)")
              .append("text").text("Positive cells").attr("text-anchor", "middle").style("font-size","13");
          }//renderbarplot2







          function renderBarplot(div,data,issort){
            


            var minv=Infinity;
            var maxv =0;

            if(issort){



            
              for(var i=0;i<data.length;i++){

                for(var j=i;j<data.length;j++){

                  var val1 = data[i]["median"];
                  var val2 = data[j]["median"];

                  if(val2 > val1){
                    temp =  data[i];
                    data[i]=data[j];
                    data[j]=temp;
                    

                  }
                }

              }

            }
            for(var i=0;i<data.length;i++){

              var tempmax = data[i]["max"];
              var tempmin = data[i]["min"];

              if(tempmin<minv){
                minv = tempmin;
              }
              if(tempmax>maxv){
                maxv = tempmax;
              }

              

            }


            


            var divwidth = $(div).width();

            var barmargin={ right:26,bottom:100,top:9, left:45};
            var width =  Math.ceil(divwidth - barmargin.left - barmargin.right);
            var height = 220;
            var barheight =height/2;
            var gap=20;




            

            $(div).html("");
            var svg = d3.select(div).append("svg").attr("id",'barsvg')
              .attr("width", width +  barmargin.left +  barmargin.right)
              .attr("height", height +  barmargin.top + barmargin.bottom+gap);

            var maxmedian=0;
            var labels=[];

            for(var i in data){

              median = data[i]["median"];
              if(median > maxmedian){

                maxmedian = median;
              }

              labels.push(data[i]["name"])


            }


            var xliner = d3.scaleLinear()
                .domain([0, labels.length+1 ])
                .range([0, width]);


            var yliner1 = d3.scaleLinear()
                .domain([0, 1])
                .range([barheight,0]);



            var yliner2 = d3.scaleLinear()
                .domain([minv, maxv])
                .range([barheight,0]);


            var xAxis = d3.axisBottom(xliner).tickFormat("").ticks(labels.length+1);
            var yAxis1 = d3.axisLeft(yliner1);
            var yAxis2 = d3.axisLeft(yliner2);

            var barg = svg.append("g").attr("id","barg").attr("transform",  "translate("+barmargin.left+"," + (barmargin.top) + ")")
            svg.append('g').attr("transform",  "translate("+barmargin.left+"," + (barmargin.top) + ")").call(yAxis1);
            svg.append('g').attr("transform",  "translate("+barmargin.left+"," + ( barmargin.top+barheight+gap) + ")").call(yAxis2); 

            svg.append('g').attr("transform", "translate("+barmargin.left+"," + (barheight+barmargin.top) + ")").call(xAxis);
            svg.append('g').attr("transform", "translate("+barmargin.left+"," + ( barmargin.top+2*barheight+gap) + ")").call(xAxis);


            for(var i=0;i<labels.length;i++){
              

              barg.append("g").attr("class","xlabel2").attr("transform", "translate("+xliner(i+1)+"," + (2*barheight+gap) + ")")
                .append("text").text(labels[i]).style("text-anchor", "end")
                      .attr("dx", "-.8em")
                      .attr("dy", ".15em")
                      .style("font-size",10)
                      .attr("transform", "rotate(-90)");


            }


            var plot1y = barheight;
            var plot2y = barheight+gap;
            var barwidth = width/data.length/2;
            var boxwidth = barwidth;
            var hf_boxwidth = barwidth/2
            if(barwidth> 33){
              barwidth =33;
            }
            for(var i=0;i<data.length;i++){

              var color = data[i]["color"];
              var percval =data[i]["perc"];
              var barh1 = yliner1(percval);
              barh1 = barheight-barh1;

              var y1 = plot1y-barh1
              var x = xliner(i+1)-(barwidth/2);

              var boxx1 = xliner(i+1)-(hf_boxwidth);
              var boxx2 = xliner(i+1)+(hf_boxwidth);


              barg.append("rect").attr("x",x).attr("y",y1).attr("width",barwidth).attr("height",barh1).style("fill",color);
              //.style("fill",data[i]["color"]);
              
              var min= yliner2(data[i]["min"]);
              var max = yliner2(data[i]["max"]);
              var median = yliner2(data[i]["median"]);
              var q1 = yliner2(data[i]["1q"]);
              var q3 = yliner2(data[i]["3q"]);
              //alert(medianval)

              
              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+median)
                .attr("y2",plot2y+median)
                .style("stroke-width",1);


              
              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+max)
                .attr("y2",plot2y+max)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+min)
                .attr("y2",plot2y+min)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+q1)
                .attr("y2",plot2y+q1)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx2)
                .attr("y1",plot2y+q3)
                .attr("y2",plot2y+q3)
                .style("stroke-width",1);


              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx1)
                .attr("x2",boxx1)
                .attr("y1",plot2y+q1)
                .attr("y2",plot2y+q3)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",boxx2)
                .attr("x2",boxx2)
                .attr("y1",plot2y+q1)
                .attr("y2",plot2y+q3)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",xliner(i+1))
                .attr("x2",xliner(i+1))
                .attr("y1",plot2y+max)
                .attr("y2",plot2y+q3)
                .style("stroke-width",1);

              barg.append("line")
                .style("stroke",color)
                .attr("role","box")
                .attr("x1",xliner(i+1))
                .attr("x2",xliner(i+1))
                .attr("y1",plot2y+q1)
                .attr("y2",plot2y+min)
                .style("stroke-width",1);


              barg.append("rect")
                .style("fill",color)
                .style("fill-opacity",0.5)
                .attr("x",boxx1)
                .attr("y",plot2y+q3)
                .attr("height",   q1-q3)
                .attr("width",2*hf_boxwidth)

              /*
              var barh2 = yliner2(medianval);
              barh2 = barheight-barh2;
              
              barg.append("rect").attr("x",x).attr("y",y2).attr("width",barwidth).attr("height",barh2).style("fill","#3376FF");
              //.style("fill",data[i]["color"]);
              */
            }
            var label1= svg.append("g").attr("class","boxbar").attr("transform", "translate( "+(barmargin.left-35)+","+(barmargin.top+gap +barheight+barheight/2)+" ) rotate(-90)")
            .append("text").text("Counts").style("font-size","13")
              .attr("text-anchor", "middle");
              //.attr("x",barmargin.left-30).attr("y",barmargin.top+barheight/2);//;
            var label2= svg.append("g").attr("class","percbar").attr("transform", "translate( "+(barmargin.left-35)+" , "+(barmargin.top+barheight/2)+" ) rotate(-90)")
              .append("text").text("Positive cells").attr("text-anchor", "middle").style("font-size","13");
            //.attr("x",barmargin.left-30).attr("y",barmargin.top+barmargin.bottom+barheight+barheight/2); 

             

          }





          function execafterselected(selectednodes){
            var targetdiv = $("#clustersInfo").find("[name='sellectcelldiv']");
            targetdiv.html("<span style='color:steelblue;'>"+selectednodes.length +"</span> cells selected &nbsp;<span name='selectedcalculationsavediv'></span>");

            //targetdiv.find("[name='selectedcalculationsavediv']").html("<button class='btn btn-primary btn-sm' name='contrastbtn'> Contrast </button>&nbsp;&nbsp;<span class='btn btn-info btn-sm' name='savebtn'> Save </span>");
            targetdiv.find("[name='selectedcalculationsavediv']").html("<button class='btn btn-primary btn-sm' name='contrastbtn'> Contrast </button>&nbsp;&nbsp;<span class='btn btn-info btn-sm' name='advanced'> More </span>");

            //$("#clustersInfo").find("[name='contrastwithselected']").show();

            targetdiv.find("[name='contrastbtn']").click(function(){

                //do contrast
                var cellids = selectednodes.join(",");

                docontrast(cellids,"ALL");
                

            })
            //




            
          
          }

           
          function renderClstrSelectMenu(data,div){
            
            div.html("<select  type='text' name='clstrnameinput'><select>");
            div.find("[name='clstrnameinput']").selectize({

                options:data,
                valueField:"_id",
                labelField:"_id",
                searchField:"_id",
                render: {
                    item: function(item, escape) {

                      return "<div>"+item._id+"</div>";
                    },
                    option: function(item, escape) {
                         

                        if("path" in item){
                            var path = item.path;

                            path.push("<span style='color:green;'>"+item._id+"</span>");

                            var path = path.join("->");

                          return '<div><span class="caption">' + path + '</span></div>';


                        }else{


                            return '<div><span class="caption">' + item._id + '</span></div>';

                        }

                        
                    }
                    
                },


            })



          }


          


          function startLoading(){


              var loadingstr='<div class="h-100" style="display: flex;justify-content: center;align-items: center;vertical-align: middle;"><div class="loader"><div class="dot dot1"><i></i></div><div class="dot dot2"><i></i></div><div class="dot dot3"><i></i></div><div class="dot dot4"><i></i></div><div class="dot dot5"><i></i></div><div class="dot dot6"><i></i></div><div class="dot dot7"><i></i></div><div class="dot dot8"><i></i></div><div class="dot dot9"><i></i></div></div></div>'



              $("#mainpanel").html(loadingstr);

              $("#infopanel").html(loadingstr);
          }


          function startLoading2(){


              $("#loadingcanvas").show();

              

              
          }

          function clearnmain(){
            $("#mainpanel").html("");

          }
          function clearninfo(){
            $("#infopanel").html("");
            
          }
          function endLoading2(){


              $("#loadingcanvas").hide();


          }

          function endLoading(){

              $("#mainpanel").html("");

              $("#infopanel").html("");


          }

          function errorLoading2(){
              $("#loadingcanvas").hide();
              $("#mainpanel").html("server error");

              $("#infopanel").html("server error");


          }

          function errorLoading(){

              $("#mainpanel").html("server error");

              $("#infopanel").html("server error");


          }


          function startLoadingDiv(div){


              var loadingstr='<div class="h-100" style="display: flex;justify-content: center;align-items: center;vertical-align: middle;"><div class="loader"><div class="dot dot1"><i></i></div><div class="dot dot2"><i></i></div><div class="dot dot3"><i></i></div><div class="dot dot4"><i></i></div><div class="dot dot5"><i></i></div><div class="dot dot6"><i></i></div><div class="dot dot7"><i></i></div><div class="dot dot8"><i></i></div><div class="dot dot9"><i></i></div></div></div>'



              div.html(loadingstr);
 
          }

          function endLoadingDiv(div){


              div.html("");


          }


          function errorLoadingDiv(div){

              div.html("server error");
          }


          function initComponents(){


              $("#dragablediv").draggable({
          
                  handle: "[name='dragabledivheader']"
              });


              $("#dragablediv").find("[name='closedragablepanel']").click(function(){

                  

                  $("#dragablediv").hide(300);

              });



              //d3.select("body").append("div").attr("id","tooltip").style("opacity",0);



          }


          function docontrast2(clusterid,target){

                $("#dragablediv").find("[name='dragablepaneltitle']").html("Contrast result");
                $("#dragablediv").show(300);

                var targetdiv = $("#dragablediv").find(".card-body");
                startLoadingDiv(targetdiv)
                $.ajax({
                      url:"/contrast2",
                      data:{"clstr":clusterid,"target":target,"sampleid":sampleObjectId},
                      method:'post',
                      dataType:"JSON",
                      success:function(data){
                        endLoadingDiv(targetdiv);
                        //alert(JSON.stringify(data.res));
                        var res=data.res;
                        renderbarplotofpvalrank(res,targetdiv,clusterid,"cid",target,selectednodes);


                        //dragablediv.
                      },error:function(){

                        //errorLoading2();

                      }

                })


          }


          function docontrast(cellids,target){
                $("#dragablediv").find("[name='dragablepaneltitle']").html("Contrast result");
                $("#dragablediv").show(300);

                var targetdiv = $("#dragablediv").find(".card-body");
                startLoadingDiv(targetdiv);

                $.ajax({
                      url:"/contrast",
                      data:{"cells":cellids,"target":target,"sampleid":sampleObjectId},
                      method:'post',
                      dataType:"JSON",
                      success:function(data){
                        endLoadingDiv(targetdiv);
                        //alert(JSON.stringify(data.res));
                        var res=data.res;
                        renderbarplotofpvalrank(res,targetdiv,cellids,"cells",target,selectednodes);


                        //dragablediv.
                      },error:function(){

                        //errorLoading2();

                      }

                })



          }


          function addDataToClsterTable(){



          }


          function removeDataFromClsterTable(){



          }


          function UpdateDataToClsterTable(){


            
          }



          function renderbarplotofpvalrank(data,div,data1,dttype,data2,selectedcells){
            //$(div).html("<svg id='rankingplot' style='width:100%;'></svg>");
            
            var p= data.p;
            var n = data.n;

            var pdata=[];
            var ndata=[];

            var temp;

            for(var i =0;i<p.length;i++){
              var g=p[i];
              var x =i%7;

              if(x===0){

                temp=[g,"","","","","",""];

              }else if(x ===6){

                temp[x]=g;
                pdata.push(temp);
                temp=[];


              }else{
                temp[x]=g;
              }
            }
            if(temp.length>0){

              pdata.push(temp);

            }

            p=null;

            temp=[]
            for(var i =0;i<n.length;i++){
              var g=n[i];
              var x =i%7;

              if(x===0){

                temp=[g,"","","","","",""];

              }else if(x ===6){

                temp[x]=g;
                ndata.push(temp);
                temp=[];


              }else{
                temp[x]=g;
              }

            }
            if(temp.length>0){

              ndata.push(temp);

            }
            n=null;




            
            div.html("<h6>Positive Genes</h6><table name='contrastPostable' class='table table-striped display table-bordered compact' style='width:100%;'></table><hr></hr><h6>Negative Genes</h6><table name='contrastNagtable' style='width:100%;' class='table table-striped display table-bordered compact'></table><hr></hr><div name='plotdiv'></div><hr></hr><div name='saveinfodiv'></div>");
            var posTable=div.find("[name='contrastPostable']").DataTable({
                searching: false,
                info: false,
                "ordering": false,
                "pageLength": 5,
                "lengthChange": false,
                               
                //"pagingType": "simple",
                "scrollX": true,
                fixedHeader: true,
                data:pdata,
                "columns": [
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"}, 
                ],
                "columnDefs": [
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 0
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                           return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 1
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 2
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                           return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 3
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                           return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 4
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 5
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                           return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 6
                    }
                     
                ]
                         

            });
            var nagTable=div.find("[name='contrastNagtable']").DataTable({

                data:ndata,
                searching: false,
                info: false,
                fixedHeader: true,
                "ordering": false,
                "pageLength": 5,
                "lengthChange": false,
                               
                "scrollX": true,
                "columns": [
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"},
                  {"width": "14.28%"}, 
                ],
                "columnDefs": [
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 0
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 1
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 2
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 3
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 4
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 5
                    },
                    {
                        
                        "render": function ( data, type, row ) {
                            return "<div style='font-size:11px;'><span class='genebtn' style='cursor:pointer;'>"+data+"</span><i canselect='F' isselected='F' class='float-right' style='cursor:pointer;color:#D3D3D3'><i class='far fa-square'></i></i></div>";
                        },
                        "targets": 6
                    } 
                     
                ]
              
            });

            div.find("th").hide();

            div.on("click",".genebtn",function(){

                div.find(".genebtn").css("color","black");
                var gene=$(this).text();
                $(this).css("color","steelblue");
                var thisdiv = $(this);
                
                //render gene expr
                //contrast gene search
                //data1,dttype,data2,sampleObjectId

                clearAllNodes();
                $.ajax({

                    url:"/contrastGeneSearch",
                    data:{"sampleid":sampleObjectId,"gene":gene,"sampleid":sampleObjectId,"data1":data1,"dttype":dttype,"data2":data2},
                    method:"post",
                    dataType:"JSON",
                    success:function(data){

                      thisdiv.parent().find("[canselect]").attr("canselect","T").css("color","steelblue");
                      var expr = data.expr;
                      var plotdata = data.plot;

                      var maxval =data.maxval;

                      var redscale = d3.scaleLinear()
                          .domain([0,maxval])
                          .range(["#ff8080", "#800000"]);

                      for(i in expr){
                        
                        d3.select("#g"+i).style("fill",redscale(expr[i]));
                      }

                      div.find("[name='plotdiv']").html("<div id='contrastbarsvgdiv'></div>");
                      renderBarplot2("#contrastbarsvgdiv",plotdata,gene,false);
                      //renderGenesearchPlot(genesearchpanel.find("[name='genesearchdetails']").find("[name='genesearchplot']"),gene);

                      

                    },
                    error:function(){


                    }

                })
                
            });

            div.on("click","[canselect='T']",function(){
                var isselected = $(this).attr("isselected");
                if(isselected==="F"){

                    $(this).attr("isselected","T").html("<i class='far fa-check-square'></i>");
                    var thisgene =  $(this).parent().find(".genebtn").text();
                    var selectedgenes=div.find("[name='saveinfodiv']").find("[name='selectedMarks']").text().trim();
                    selectedgenes=selectedgenes.split(",");

                    var resultgenes=[];
                    for(var i in selectedgenes){
                      if(selectedgenes[i] !==thisgene  && selectedgenes[i] !==""){

                        resultgenes.push(selectedgenes[i])
                      }

                    }
                    resultgenes.push(thisgene);
                    div.find("[name='saveinfodiv']").find("[name='selectedMarks']").html(resultgenes.join(","));



                }else if(isselected==="T"){

                    $(this).attr("isselected","F").html("<i class='far fa-square'></i>");


                    var thisgene =  $(this).parent().find(".genebtn").text();
                    var selectedgenes=div.find("[name='saveinfodiv']").find("[name='selectedMarks']").text().trim();
                    selectedgenes=selectedgenes.split(",");

                    var resultgenes=[];
                    for(var i in selectedgenes){
                      if(selectedgenes[i] !==thisgene  && selectedgenes[i] !==""){

                        resultgenes.push(selectedgenes[i])
                      }

                    }

                    div.find("[name='saveinfodiv']").find("[name='selectedMarks']").html(resultgenes.join(","));



                }


            });

            var savestr='<span>selected Mark Genes</span><br><div name="selectedMarks" class="card card-body" style="min-height:30px;"></div>';

            var userrole = sessionStorage.getItem("userrole");
            if(userrole==="admin"){

                savestr+='<br><div><span>Do you want to save this cluster ?</span>&nbsp;&nbsp;&nbsp;<button class="btn btn-success btn-sm" name="savebtn"> Save </button></div>'
                


            }


            div.find("[name='saveinfodiv']").html(savestr);
            //selectedcells


            

            





            div.find("[name='saveinfodiv']").find("[name='savebtn']").click(function(){


              $("#defaultModal").find(".modal-title").html("Cluster Editor");
              $("#defaultModal").find(".modal-footer").html("");
                     
              var modalbody = $("#defaultModal").find(".modal-body");
              modalbody.html("wait...");


              $.ajax({

                url:"/queryClstrType",
                method:'post',
                dataType:"JSON",
                success:function(data){
                        //endLoading2();
                  var clstrtypearray=data.data;
                  var optstr=""
                  for(var i in clstrtypearray){

                    optstr+="<option value='"+clstrtypearray[i]+"'>"+clstrtypearray[i]+"</option>";

                  }


                  var markgenesstr = div.find("[name='saveinfodiv']").find("[name='selectedMarks']").text();


                  modalbody.html("<div><span>Cluster Type:</span><select class='form-control form-control-sm' name='clstrtypeinput'>"+optstr+"</select></div>");
                  modalbody.append("<div><span>Cluster Name :</span><div name='clstrnameinputdiv'></div></div>");
                  modalbody.append("<div><span>Mark Genes:</span><textarea class='form-control' name='markgenestextarea'>"+markgenesstr+"</textarea></div>");
                  modalbody.append("<div><span>Comment:</span><textarea  type='text' class='form-control form-control-sm' name='clstrcommentinput'></textarea></div><div style='height:5px;'></div>");
                  modalbody.append("<button name='saveclstrbtn' class='btn btn-primary btn-sm'>Save</button>");
                  modalbody.find("[name='clstrtypeinput']").change(function(){

                      var clstrtype = modalbody.find("[name='clstrtypeinput']").val();
                      renderclusternameinput(clstrtype,modalbody.find("[name='clstrnameinputdiv']"));

                  });
                  modalbody.find("[name='clstrtypeinput']").trigger("change");

                  modalbody.find("[name='saveclstrbtn']").click(function(){
                      var name = modalbody.find("[name='clstrnameinput']").val();
                      var type = modalbody.find("[name='clstrtypeinput']").val();
                      var comment = modalbody.find("[name='clstrcommentinput']").val();
                      var markgenes = modalbody.find("[name='markgenestextarea']").val();

                      name = name.trim();
                      if(name !==""){

                          dosaveclstr(name,type,comment,markgenes,selectedcells,div.find("[name='saveinfodiv']"));
                      }else{


                        alert("input a name of cluster");
                      }
                      

                  })


                },error:function(){

                    modalbody.html("get error from server");  
                }



              })


              



              $("#defaultModal").modal("show");




            })//savebtn



            















          }



          function dosaveclstr(name,type,comment,markgenes,selectedcells,div){

              $.ajax({
                        url:"/savecluster",
                        data:{"sampleid":sampleObjectId,name:name,type:type,comment:comment,"cells":selectedcells.join(","),"marks":markgenes},
                        method:"post",
                        dataType:"JSON",
                        success:function(data){
                          
                          if(data.status==="success"){

                              div.html("<span style='color:green;'>success</span>");
                              //clusterTable
                              var thismarkgenes= markgenes.split(",");
                              var cid = data.cid;
                              var color = data.color;

                              var newdata={"prerender":false,name:name,marks:thismarkgenes,cid:cid,color:color}
                              clusterTable.row.add(newdata).draw();
                               

                              $("#defaultModal").modal("hide");

                          }else{

                              div.html("<span style='color:red;'>save cluster error</span>");
                              $("#defaultModal").modal("hide");
                          }

                        },
                        error:function(){
                            div.html("<span style='color:red;'>save cluster error</span>");
                            $("#defaultModal").modal("hide");
                        }



              })



          }//dosaveclstr end




          function renderclusternameinput(clstr,div){
                
                 
                  $.ajax({
                      url:"/getClusterClassification",
                      data:{"clstrType":clstr},
                      method:'post',
                      dataType:"JSON",
                      success:function(data){
                        //endLoading2();
                        data = data.clstrTypes;

                        renderClstrSelectMenu(data,div);


                      },error:function(){

                        //errorLoading2();

                      }

                  })


                
                

          }




      });

    </script>






  </body>
</html>